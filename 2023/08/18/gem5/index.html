<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
<meta name="referrer" content="no-referrer">
  <link rel="apple-touch-icon" sizes="180x180" href="/zyhjy/images/relativity128.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/zyhjy/images/relativity32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/zyhjy/images/relativity16.png">
  <link rel="mask-icon" href="/zyhjy/images/logo.svg" color="#222">

<link rel="stylesheet" href="/zyhjy/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Comic Sans MS:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/zyhjy/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/zyhjy/lib/pace/pace-theme-minimal.min.css">
  <script src="/zyhjy/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zyh-eric.gitee.io","root":"/zyhjy/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="è¿™ç¯‡æ–‡ç« ç”¨äºè®°å½•åœ¨åšå®éªŒå®¤é¡¹ç›®æ—¶é‡åˆ°çš„gem5 O3CPUç›¸å…³çš„çŸ¥è¯†ï¼Œå¯¹åº”çš„gem5ç‰ˆæœ¬ä¸º21.2.0.0ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="gem5 O3CPU guidelines">
<meta property="og:url" content="https://zyh-eric.gitee.io/zyhjy/2023/08/18/gem5/">
<meta property="og:site_name" content="ZYHJY">
<meta property="og:description" content="è¿™ç¯‡æ–‡ç« ç”¨äºè®°å½•åœ¨åšå®éªŒå®¤é¡¹ç›®æ—¶é‡åˆ°çš„gem5 O3CPUç›¸å…³çš„çŸ¥è¯†ï¼Œå¯¹åº”çš„gem5ç‰ˆæœ¬ä¸º21.2.0.0ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-18T10:18:40.000Z">
<meta property="article:modified_time" content="2023-09-11T08:29:15.112Z">
<meta property="article:author" content="Yuhang Zhang">
<meta property="article:tag" content="lab">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zyh-eric.gitee.io/zyhjy/2023/08/18/gem5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>gem5 O3CPU guidelines | ZYHJY</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J17VP3T2B4"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J17VP3T2B4');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/zyhjy/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ZYHJY</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/zyhjy/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/zyhjy/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/zyhjy/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/zyhjy/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/zyhjy/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-solutions">

    <a href="/zyhjy/solutions/" rel="section"><i class="fa fa-code fa-fw"></i>ç®—æ³•é¢˜è§£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zyh-eric.gitee.io/zyhjy/2023/08/18/gem5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/zyhjy/images/zyhjy.png">
      <meta itemprop="name" content="Yuhang Zhang">
      <meta itemprop="description" content="çˆ±å°é›…ï¼Œçˆ±ç”Ÿæ´»ï¼Œçˆ±ç‰©ç†!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZYHJY">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          gem5 O3CPU guidelines
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-08-18 18:18:40" itemprop="dateCreated datePublished" datetime="2023-08-18T18:18:40+08:00">2023-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-09-11 16:29:15" itemprop="dateModified" datetime="2023-09-11T16:29:15+08:00">2023-09-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/zyhjy/categories/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">ä½“ç³»ç»“æ„</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/zyhjy/categories/gem5/" itemprop="url" rel="index"><span itemprop="name">gem5</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>13 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>è¿™ç¯‡æ–‡ç« ç”¨äºè®°å½•åœ¨åšå®éªŒå®¤é¡¹ç›®æ—¶é‡åˆ°çš„gem5
O3CPUç›¸å…³çš„çŸ¥è¯†ï¼Œå¯¹åº”çš„gem5ç‰ˆæœ¬ä¸º21.2.0.0ã€‚</p>
<span id="more"></span>
<h1 id="gem5-o3cpu-guidelines">gem5 O3CPU guidelines</h1>
<h2 id="interaction-of-cpu-model-with-other-parts-of-gem5">Interaction
of CPU model with other parts of gem5</h2>
<figure>
<img
src="https://gitee.com/zyh-eric/mypics/raw/master/img/image-20230818201426319.png"
alt="image-20230818201426319" />
<figcaption aria-hidden="true">image-20230818201426319</figcaption>
</figure>
<h2 id="fetch">fetch</h2>
<h3 id="fetchdecoderä¸macro-opmicro-op">1.
<code>fetch::decoder</code>ä¸macro opã€micro op</h3>
<p>åœ¨çœŸå®CPUä¸­ï¼ŒCPUè·å¾—ä»PCåœ°å€å–å‡ºä¸€æ¡æŒ‡ä»¤åï¼Œéœ€è¦å°†æŒ‡ä»¤ä»æœºå™¨ç ï¼ˆäºŒè¿›åˆ¶è¡¨ç¤ºçš„æŒ‡ä»¤ï¼‰è½¬åŒ–ä¸ºå†…éƒ¨æ§åˆ¶ä¿¡å·å’Œæ“ä½œç ï¼Œä»¥ä¾¿
CPU å¯ä»¥ç†è§£å¹¶æ‰§è¡ŒæŒ‡ä»¤ï¼Œç„¶åç”±ç»†åˆ†çš„ç¡¬ä»¶è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚</p>
<p>ç±»ä¼¼çš„ï¼Œå½“gem5 cpuè¿›è¡Œæ¨¡æ‹Ÿæ—¶ï¼Œä¹Ÿéœ€è¦å°†ç¨‹åºçš„æœºå™¨ç è§£ç æˆgem5
cpuå†…éƒ¨å¤„ç†çš„ä¿¡æ¯,åœ¨gem5æºç ä¸­ä¸º<code>o3::StaticInst</code>ï¼Œè§£ç çš„å·¥ä½œç”±<code>fetch::decoder</code>å®Œæˆã€‚</p>
<p>å¯¹äºä¸€æ¡ç›®æ ‡ç¨‹åºçš„æœºå™¨ç æ¥è¯´ï¼Œå…¶å¯¹åº”çš„<code>o3::StaticInst</code>å¯èƒ½ä¸æ­¢ä¸€æ¡ï¼Œå¦‚arm64æ¶æ„ä¸‹çš„<code>stp(store pair)</code>æŒ‡ä»¤ï¼Œä¼šè¢«åˆ†è§£ä¸ºä¸¤æ¡ç±»å‹ä¸º<code>str</code>çš„<code>o3::StaticInst</code>æŒ‡ä»¤ã€‚</p>
<p>è¿™æ—¶ï¼Œå°±å¼•å‡ºäº†macro opå’Œmicro opçš„æ¦‚å¿µã€‚</p>
<p>æˆ‘ä»¬å°†<code>o3::StaticInst</code>ç§°ä¸ºmicro
opï¼Œå¦‚æœä¸€æ¡æœºå™¨ç åˆ†è§£ä¸ºå¤šæ¡micro opï¼Œåˆ™ç§°è¯¥æœºå™¨ç ä¸ºmacro opã€‚</p>
<p>ä»¥ä¸‹æ˜¯ç›¸å…³ä»£ç :</p>
<p>function : <code>Fetch::fetch(bool &amp;status_change)</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">  StaticInstPtr staticInst = <span class="literal">NULL</span>;</span><br><span class="line">  StaticInstPtr curMacroop = macroop[tid];		<span class="comment">/// å¦‚æœä¸Šä¸ªtickå­˜åœ¨æ²¡æœ‰å¤„ç†å®Œçš„macroopï¼Œåˆ™å–å‡º</span></span><br><span class="line">...</span><br><span class="line">  <span class="keyword">auto</span> *dec_ptr = decoder[tid];								<span class="comment">/// æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„decoderï¼Œä¿å­˜çŠ¶æ€</span></span><br><span class="line">...</span><br><span class="line">  <span class="comment">/// fetché˜¶æ®µçš„main loop, ä¼ ç»™ä¸‹ä¸ªé˜¶æ®µå°½å¯èƒ½å¤šçš„micro op</span></span><br><span class="line">  <span class="keyword">while</span> (numInst &lt; fetchWidth &amp;&amp; fetchQueue[tid].<span class="built_in">size</span>() &lt; fetchQueueSize</span><br><span class="line">         &amp;&amp; !predictedBranch &amp;&amp; !quiesce) &#123;</span><br><span class="line">      ...</span><br><span class="line">      Addr fetchBufferBlockPC = <span class="built_in">fetchBufferAlignPC</span>(fetchAddr);</span><br><span class="line">    </span><br><span class="line">    	<span class="keyword">if</span> (needMem) &#123;</span><br><span class="line">          <span class="comment">// If buffer is no longer valid or fetchAddr has moved to point</span></span><br><span class="line">          <span class="comment">// to the next cache block then start fetch from icache.</span></span><br><span class="line">          <span class="keyword">if</span> (!fetchBufferValid[tid] ||</span><br><span class="line">              fetchBufferBlockPC != fetchBufferPC[tid])</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (blkOffset &gt;= numInsts) &#123;</span><br><span class="line">              <span class="comment">// We need to process more memory, but we&#x27;ve run out of the</span></span><br><span class="line">              <span class="comment">// current block.</span></span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="built_in">memcpy</span>(dec_ptr-&gt;<span class="built_in">moreBytesPtr</span>(),</span><br><span class="line">                  fetchBuffer[tid] + blkOffset * instSize, instSize);</span><br><span class="line">          decoder[tid]-&gt;<span class="built_in">moreBytes</span>(this_pc, fetchAddr);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (dec_ptr-&gt;<span class="built_in">needMoreBytes</span>()) &#123;	<span class="comment">/// decoderæ˜¯å¦å¯ä»¥æ¥æ”¶æ›´å¤šçš„dataï¼Œè§3.</span></span><br><span class="line">              blkOffset++;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    	...</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!(curMacroop)) &#123;</span><br><span class="line">            	<span class="comment">/// instReady()è¡¨ç¤ºå½“å‰decoderå†…æœ‰å‡†å¤‡å¥½çš„æŒ‡ä»¤ï¼Œå¯ä»¥è¿›è¡Œdecode</span></span><br><span class="line">              <span class="keyword">if</span> (dec_ptr-&gt;<span class="built_in">instReady</span>()) &#123;</span><br><span class="line">                  staticInst = dec_ptr-&gt;<span class="built_in">decode</span>(this_pc);</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// Increment stat of fetched instructions.</span></span><br><span class="line">                  ++fetchStats.insts;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span> (staticInst-&gt;<span class="built_in">isMacroop</span>()) &#123;</span><br><span class="line">                      curMacroop = staticInst;	<span class="comment">/// macro opå•ç‹¬æ ‡è®°</span></span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// We need more bytes for this instruction so blkOffset and</span></span><br><span class="line">                  <span class="comment">// pcOffset will be updated</span></span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Whether we&#x27;re moving to a new macroop because we&#x27;re at the</span></span><br><span class="line">          <span class="comment">// end of the current one, or the branch predictor incorrectly</span></span><br><span class="line">          <span class="comment">// thinks we are...</span></span><br><span class="line">          <span class="type">bool</span> newMacro = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">if</span> (curMacroop) &#123;</span><br><span class="line">              staticInst = curMacroop-&gt;<span class="built_in">fetchMicroop</span>(this_pc.<span class="built_in">microPC</span>());</span><br><span class="line">              newMacro |= staticInst-&gt;<span class="built_in">isLastMicroop</span>();</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          DynInstPtr instruction = <span class="built_in">buildInst</span>(</span><br><span class="line">                  tid, staticInst, curMacroop, this_pc, *next_pc, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">          ppFetch-&gt;<span class="built_in">notify</span>(instruction);</span><br><span class="line">          numInst++;</span><br><span class="line"></span><br><span class="line">          <span class="built_in">set</span>(next_pc, this_pc);</span><br><span class="line">          ...</span><br><span class="line">          newMacro |= this_pc.<span class="built_in">instAddr</span>() != next_pc-&gt;<span class="built_in">instAddr</span>();</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Move to the next instruction, unless we have a branch.</span></span><br><span class="line">          <span class="built_in">set</span>(this_pc, *next_pc);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (newMacro) &#123;	<span class="comment">/// å¦‚æœå½“å‰æŒ‡ä»¤decodeå®Œæˆï¼Œåˆ™å¼€å¯æ–°çš„æŒ‡ä»¤decode</span></span><br><span class="line">              fetchAddr = this_pc.<span class="built_in">instAddr</span>() &amp; pc_mask;</span><br><span class="line">              blkOffset = (fetchAddr - fetchBufferPC[tid]) / instSize;</span><br><span class="line">              curMacroop = <span class="literal">NULL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        	...</span><br><span class="line">      &#125; <span class="keyword">while</span> ((curMacroop || dec_ptr-&gt;<span class="built_in">instReady</span>()) &amp;&amp;</span><br><span class="line">               numInst &lt; fetchWidth &amp;&amp;</span><br><span class="line">               fetchQueue[tid].<span class="built_in">size</span>() &lt; fetchQueueSize);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  macroop[tid] = curMacroop;</span><br><span class="line">  fetchOffset[tid] = pcOffset;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="inrom">2. inRom</h3>
<p>upcçš„æœ€é«˜ä½è®°å½•MicroPCæ˜¯å¦åœ¨Romä¸­,x86ç­‰æ¶æ„ä¼šç”¨åˆ°ï¼Œarm64ä¸ä¼šä½¿ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> inRom = <span class="built_in">isRomMicroPC</span>(this_pc.<span class="built_in">microPC</span>());		</span><br></pre></td></tr></table></figure>
<h3 id="fetchdecoderä¸pcoffset">3.
<code>fetch::decoder</code>ä¸<code>pcOffset</code></h3>
<p>decoderæœ‰ä¸¤ä¸ªæˆå‘˜å‡½æ•°</p>
<ul>
<li><code>bool needMoreBytes()</code>: Can the decoder accept more data?
<ul>
<li>A CPU model uses this method to determine if the decoder can accept
more data. Note that an instruction can be ready (see instReady() even
if this method returns true.</li>
</ul></li>
<li><code>bool instReady()</code> : Is an instruction ready to be
decoded?
<ul>
<li>CPU models call this method to determine if decode() will return a
new instruction on the next call. It typically only returns false if the
decoder hasn't received enough data to decode a full instruction.</li>
</ul></li>
</ul>
<p>è¿™ä¸¤ä¸ªæˆå‘˜å‡½æ•°ç»„åˆèµ·æ¥å¯ä»¥å¤„ç†ä¸å®šé•¿æŒ‡ä»¤é›†ã€‚</p>
<p>å¦‚æœæŸæŒ‡ä»¤é•¿åº¦è¶…è¿‡é»˜è®¤çš„æŒ‡ä»¤å­—é•¿ï¼Œ<code>instReady()</code>å°†è¿”å›false,åˆ™è¯´æ˜decoderéœ€è¦æ›´å¤šçš„dataç”¨äºdecodeï¼Œ<code>pcOffset</code>åˆ™æ˜¯è®°å½•æ¥ä¸‹æ¥è¦å–çš„dataä¸å½“å‰pcçš„åç§»ã€‚æ¯å½“å¤„ç†ä¸€æ¡æ–°æŒ‡ä»¤çš„æ—¶å€™ï¼Œ<code>pcOffset</code>å½’é›¶ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šå½“å‰<code>pc</code>ä¸º<code>0x4002b0</code>ï¼ŒæŒ‡ä»¤å­—é•¿ä¸º4byteï¼Œdecoderè¯»å…¥4byteçš„æ•°æ®ï¼Œ<code>pcOffset</code>ä¸º4ï¼›ä½†æ˜¯decoerå‘ç°è¯¥æŒ‡ä»¤æ˜¯8byteé•¿ï¼Œæ— æ³•è¿›è¡Œdecodeï¼Œ<code>instReady()</code>è¿”å›falseï¼›fetchå°†ä»<code>pc + pcOffset = 0x4002b4</code>å†è¯»å‡º4byteæ•°æ®ç»™decoderä»¥å®Œæˆdecodeã€‚</p>
<p>å¦‚æœå½“å‰tickå¤„ç†ç»“æŸ(æ¯”å¦‚ä¼ è¾“ç»™decode
stageçš„æŒ‡ä»¤æ•°ä»¥è¾¾åˆ°fetchWidth)ï¼Œåˆ™ä¿å­˜pcOffsetä¾›ä¸‹ä¸ªtickä½¿ç”¨ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetchOffset[tid] = pcOffset;</span><br></pre></td></tr></table></figure>
<p>arm64æŒ‡ä»¤é›†æ˜¯é•¿åº¦ä¸º32bitçš„å®šé•¿æŒ‡ä»¤é›†ï¼Œä¸ä¼šå‡ºç°<code>instReady()</code>è¿”å›falseçš„æƒ…å†µï¼Œæ•…<code>pcOffset</code>ä¸ä¼šç”¨åˆ°ã€‚</p>
<h3 id="pcmask">4. pcMask()</h3>
<p><code>pcMask()</code>çš„ä½œç”¨æ˜¯ä½¿åœ°å€å¯¹é½ï¼Œå¯¹äº32bitå®šé•¿æŒ‡ä»¤çš„arm64æ¥è¯´ï¼Œéœ€è¦ä¿è¯åœ°å€4å­—èŠ‚å¯¹é½ï¼Œæ•…<code>pcMask = 0xfffffffffffffffc</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Addr fetchAddr = this_pc.<span class="built_in">instAddr</span>() &amp; decoder[tid]-&gt;<span class="built_in">pcMask</span>();</span><br></pre></td></tr></table></figure>
<h3 id="fetchdecodermorebytes">5.
<code>fetch::decoder::moreBytes()</code></h3>
<p>å°†æ•°æ®ä¼ é€è‡³è§£ç å™¨ã€‚</p>
<p>CPUæ¨¡å‹ä½¿ç”¨æ­¤æ¥å£å°†æŒ‡ä»¤æ•°æ®åŠ è½½åˆ°è§£ç å™¨ä¸­ã€‚ä¸€æ—¦åŠ è½½äº†è¶³å¤Ÿçš„æ•°æ®ï¼ˆä½¿ç”¨instReady()è¿›è¡Œæ£€æŸ¥ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨decode(PCStateBase
&amp;)æ¥æ£€ç´¢è§£ç åçš„æŒ‡ä»¤ã€‚</p>
<p>è¿™ç§æ–¹æ³•æ—¨åœ¨æ”¯æŒå›ºå®šé•¿åº¦å’Œå¯å˜é•¿åº¦çš„æŒ‡ä»¤ã€‚æŒ‡ä»¤æ•°æ®ä»¥MachInstå—çš„å½¢å¼è·å–ï¼ˆå¯¹åº”äºå…¸å‹æŒ‡ä»¤çš„å¤§å°ï¼‰ã€‚å¦‚æœæŒ‡ä»¤è·¨è¶Šå¤šä¸ªå—ï¼Œåˆ™å¯èƒ½éœ€è¦å¤šæ¬¡è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>fetch::decoder::moreBytesPtr()</code>å°†è¿”å›trueï¼Œè€Œ<code>instReady()</code>å°†è¿”å›falseã€‚</p>
<p>fetchPCå‚æ•°ç”¨äºæŒ‡ç¤ºä»å†…å­˜ä¸­è·å–æŒ‡ä»¤çš„ä½ç½®ã€‚è¿™åº”è¯¥ä¸PCç›¸åŒã€‚å¦‚æœè·å–å¤šä¸ªå—ï¼Œåˆ™å®ƒæŒ‡ç¤ºä»å“ªé‡Œè·å–åç»­å—<code>ï¼ˆpc + n * sizeof(MachInst)ï¼‰</code>ã€‚</p>
<p>å‚æ•°:</p>
<ul>
<li>pc æˆ‘ä»¬æ­£åœ¨è§£ç çš„æŒ‡ä»¤æŒ‡é’ˆã€‚</li>
<li>fetchPC ä»ä¸­è·å–æ­¤å—çš„åœ°å€ã€‚</li>
</ul>
<h3 id="blkoffset">6. blkOffset</h3>
<p>è®°å½•æŒ‡ä»¤åœ¨cache lineä¸­çš„offset.</p>
<h3 id="fetchfetchcacheline">7. Fetch::fetchCacheLine</h3>
<p>translateTiming(req, tc, translation, mode, NormalTran, false);</p>
<p>Request::INST_FETCH flag å‘¼åº”mmu req-&gt;isInstFetch()</p>
<p>SCTLR (System Control Register) åœ¨ ARMv8 æ¶æ„çš„ Memory Management
Unit (MMU) ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å¯„å­˜å™¨ã€‚SCTLR
æ§åˆ¶äº†å¤„ç†å™¨çš„ä¸€äº›é‡è¦ç‰¹æ€§å’Œæ“ä½œæ¨¡å¼ï¼ŒåŒ…æ‹¬è™šæ‹Ÿå†…å­˜çš„ç®¡ç†ã€‚å®ƒçš„å…¨åæ˜¯
"System Control Register (EL1)"ï¼Œè¡¨ç¤ºåœ¨ EL1 (Exception Level 1)
æ¨¡å¼ä¸‹çš„ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨ã€‚</p>
<p>åœ¨ SCTLR ä¸­ï¼Œæœ‰è®¸å¤šä½ç”¨äºæ§åˆ¶ä¸åŒçš„ç³»ç»Ÿè¡Œä¸ºã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ SCTLR
ä½åŠå…¶åŠŸèƒ½ï¼š</p>
<ol type="1">
<li><p>M (Bit 0): æ§åˆ¶ MMU çš„æ•´ä½“ä½¿èƒ½ã€‚å¦‚æœ M
ä½è¢«æ¸…é›¶ï¼Œå°†ç¦ç”¨è™šæ‹Ÿå†…å­˜æ”¯æŒï¼Œè¿™æ„å‘³ç€å¤„ç†å™¨å°†ä»¥ç‰©ç†åœ°å€æ¨¡å¼è¿è¡Œã€‚</p></li>
<li><p>C (Bit 2): æ§åˆ¶ç¼“å­˜ä½¿èƒ½ã€‚å¦‚æœ C
ä½è¢«æ¸…é›¶ï¼Œå°†ç¦ç”¨æ•°æ®ç¼“å­˜ã€‚</p></li>
<li><p>I (Bit 12): æ§åˆ¶æŒ‡ä»¤ç¼“å­˜ä½¿èƒ½ã€‚å¦‚æœ I
ä½è¢«æ¸…é›¶ï¼Œå°†ç¦ç”¨æŒ‡ä»¤ç¼“å­˜ã€‚</p></li>
<li><p>A (Bit 15): å¼ºåˆ¶å¯¹é½è®¿é—®ä½¿èƒ½ã€‚å¦‚æœ A
ä½è¢«è®¾ç½®ï¼Œå¤„ç†å™¨å°†æ‰§è¡Œå¼ºåˆ¶å¯¹é½æ£€æŸ¥ã€‚</p></li>
<li><p>SA0 (Bits 21:22) å’Œ SA (Bits 23:24):
æ§åˆ¶æ ˆå¯¹é½ã€‚è¿™äº›ä½ç”¨äºé…ç½®å †æ ˆçš„å¯¹é½æ–¹å¼ã€‚</p></li>
<li><p>EE (Bit 25): å¼‚å¸¸ç«¯ç‚¹ã€‚å¦‚æœ EE
ä½è¢«è®¾ç½®ï¼Œå¼‚å¸¸å°†å‘ç”Ÿåœ¨æŒ‡ä»¤æ‰§è¡Œçš„ç»“æŸé˜¶æ®µã€‚</p></li>
<li><p>VE (Bit 24): è™šæ‹ŸåŒ–ä½¿èƒ½ã€‚å¦‚æœ VE
ä½è¢«è®¾ç½®ï¼Œå°†å¯ç”¨è™šæ‹ŸåŒ–æ”¯æŒã€‚</p></li>
</ol>
<p>è¯·æ³¨æ„ï¼ŒSCTLR
çš„ç²¾ç¡®é…ç½®å’Œä½çš„å«ä¹‰å¯èƒ½ä¼šå› å¤„ç†å™¨çš„å…·ä½“å®ç°è€Œæœ‰æ‰€ä¸åŒï¼Œå› æ­¤åœ¨ç‰¹å®šçš„
ARMv8 å¤„ç†å™¨æ‰‹å†Œä¸­å¯ä»¥æ‰¾åˆ°è¯¦ç»†çš„ä¿¡æ¯ã€‚é…ç½® SCTLR æ˜¯é…ç½® ARMv8
å¤„ç†å™¨çš„å…³é”®éƒ¨åˆ†ï¼Œä»¥é€‚åº”ç‰¹å®šçš„ç³»ç»Ÿéœ€æ±‚å’Œåº”ç”¨åœºæ™¯ã€‚</p>
<p>åœ¨ARMv8æ¶æ„ä¸­ï¼ŒHCR (Hypervisor Configuration Register)
æ˜¯ä¸€ä¸ªç‰¹æ®Šå¯„å­˜å™¨ï¼Œç”¨äºæ§åˆ¶è™šæ‹ŸåŒ–å’ŒHypervisoræ¨¡å¼ä¸‹çš„é…ç½®ã€‚HCRå¯„å­˜å™¨çš„ä½œç”¨æ˜¯å…è®¸è™šæ‹Ÿæœºç›‘è§†ç¨‹åºï¼ˆVMMï¼ŒVirtual
Machine Monitorï¼‰åœ¨ARMè™šæ‹ŸåŒ–ç¯å¢ƒä¸­æ§åˆ¶è™šæ‹Ÿæœºçš„è¡Œä¸ºã€‚</p>
<p>HCRå¯„å­˜å™¨çš„ä½å­—æ®µé€šå¸¸åŒ…æ‹¬ä»¥ä¸‹é‡è¦åŠŸèƒ½ï¼š</p>
<ol type="1">
<li><p><strong>VMï¼ˆVirtualization
Modeï¼‰ä½¿èƒ½ä½</strong>ï¼šå®ƒå…è®¸æˆ–ç¦ç”¨è™šæ‹ŸåŒ–æ¨¡å¼ã€‚å½“VMä½¿èƒ½ä½è¢«è®¾ç½®æ—¶ï¼Œå¤„ç†å™¨å°†è¿›å…¥è™šæ‹ŸåŒ–æ¨¡å¼ï¼Œå…è®¸å¤šä¸ªè™šæ‹ŸæœºåŒæ—¶è¿è¡Œã€‚å½“VMä½¿èƒ½ä½è¢«æ¸…é™¤æ—¶ï¼Œå¤„ç†å™¨å°†ä»¥éè™šæ‹ŸåŒ–æ¨¡å¼è¿è¡Œï¼Œå…è®¸å•ä¸€æ“ä½œç³»ç»Ÿæˆ–ç›‘è§†ç¨‹åºæ§åˆ¶æ•´ä¸ªç³»ç»Ÿã€‚</p></li>
<li><p><strong>TCRï¼ˆTranslation Control
Registerï¼‰çš„EL2ä½</strong>ï¼šå®ƒå…è®¸è™šæ‹Ÿæœºç›‘è§†ç¨‹åºè®¾ç½®è™šæ‹Ÿæœºçš„åœ°å€è½¬æ¢æ§åˆ¶å¯„å­˜å™¨ï¼ˆTCRï¼‰çš„å€¼ã€‚è¿™æ˜¯ä¸ºäº†æ”¯æŒè™šæ‹Ÿæœºè‡ªå·±çš„åœ°å€ç©ºé—´æ˜ å°„å’Œç®¡ç†ã€‚</p></li>
<li><p><strong>å…¨å±€ä¸­æ–­ä½¿èƒ½ä½</strong>ï¼šHCRä¸­å¯èƒ½è¿˜åŒ…æ‹¬ä¸€äº›ç”¨äºæ§åˆ¶è™šæ‹Ÿæœºçš„ä¸­æ–­å¤„ç†çš„ä½å­—æ®µã€‚</p></li>
</ol>
<p>HCRå¯„å­˜å™¨çš„ç¡®åˆ‡ç»†èŠ‚å¯èƒ½ä¼šæ ¹æ®ARMv8æ¶æ„çš„ç‰¹å®šå®ç°è€Œæœ‰æ‰€ä¸åŒã€‚å› æ­¤ï¼Œå¦‚æœä½ æ­£åœ¨ç¼–å†™è™šæ‹Ÿæœºç›‘è§†ç¨‹åºæˆ–éœ€è¦è¯¦ç»†äº†è§£HCRå¯„å­˜å™¨çš„é…ç½®ï¼Œè¯·å‚è€ƒç›¸å…³çš„ARMæ¶æ„æ–‡æ¡£æˆ–å¤„ç†å™¨æ‰‹å†Œï¼Œä»¥è·å–é’ˆå¯¹ä½ çš„ç‰¹å®šç¡¬ä»¶å®ç°çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
<p>åœ¨ARMv8æ¶æ„ä¸­ï¼ŒTCRä»£è¡¨Translation Control
Registerï¼ˆç¿»è¯‘æ§åˆ¶å¯„å­˜å™¨ï¼‰ï¼Œç”¨äºé…ç½®å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰çš„è¡Œä¸ºã€‚TCRä¸­åŒ…å«äº†ä¸€äº›å­—æ®µï¼Œç”¨äºæ§åˆ¶è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„ç¿»è¯‘ã€‚å…·ä½“è€Œè¨€ï¼ŒTCRçš„å­—æ®µå¯ä»¥é…ç½®é¡µè¡¨ã€è™šæ‹Ÿåœ°å€çš„ä½æ•°ã€ç¼“å­˜ç­–ç•¥ä»¥åŠä¸€äº›å®‰å…¨ç‰¹æ€§ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ARMv8æ¶æ„ä¸­TCRçš„ä¸€äº›é‡è¦å­—æ®µå’ŒåŠŸèƒ½ï¼š</p>
<ol type="1">
<li><p><strong>T0SZå’ŒT1SZ</strong>ï¼šè¿™äº›å­—æ®µåˆ†åˆ«ç”¨äºé…ç½®ç¬¬ä¸€çº§å’Œç¬¬äºŒçº§é¡µè¡¨çš„è™šæ‹Ÿåœ°å€ä½æ•°ã€‚å®ƒä»¬å†³å®šäº†è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¤§å°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœT0SZè®¾ç½®ä¸º32ï¼Œé‚£ä¹ˆç¬¬ä¸€çº§é¡µè¡¨å°†ä½¿ç”¨32ä½çš„è™šæ‹Ÿåœ°å€ã€‚</p></li>
<li><p><strong>T2SZ</strong>ï¼šç”¨äºé…ç½®ç¬¬ä¸‰çº§é¡µè¡¨çš„è™šæ‹Ÿåœ°å€ä½æ•°ã€‚</p></li>
<li><p><strong>TG0å’ŒTG1</strong>ï¼šè¿™äº›å­—æ®µæ§åˆ¶é¡µè¡¨çš„ç²’åº¦ã€‚å¯ä»¥é€‰æ‹©4KBæˆ–64KBçš„é¡µå¤§å°ã€‚</p></li>
<li><p><strong>IPS</strong>ï¼šç”¨äºé…ç½®é¡µè¡¨çš„é¡µè¡¨çº§æ•°ã€‚è¾ƒä½çš„å€¼å¯¹åº”äºæ›´å¤šçš„é¡µè¡¨çº§åˆ«ï¼Œä»è€Œå…è®¸æ›´çµæ´»çš„å†…å­˜æ˜ å°„ã€‚</p></li>
<li><p><strong>SH0å’ŒSH1</strong>ï¼šç”¨äºé…ç½®å†…å­˜åŒºåŸŸçš„å…±äº«å±æ€§ï¼Œå¦‚å†…å­˜åŒºåŸŸæ˜¯å¦å¯å…±äº«æˆ–ç§æœ‰ã€‚</p></li>
<li><p><strong>ORGN0å’ŒORGN1</strong>ï¼šç”¨äºé…ç½®å†…å­˜åŒºåŸŸçš„åŸç‚¹ï¼ˆcacheabilityï¼‰å±æ€§ï¼Œä¾‹å¦‚ï¼Œæ˜¯å¦å¯ç¼“å­˜æˆ–ä¸å¯ç¼“å­˜ã€‚</p></li>
<li><p><strong>IRGN0å’ŒIRGN1</strong>ï¼šç”¨äºé…ç½®å†…å­˜åŒºåŸŸçš„æŒ‡ä»¤åŒºåŸŸï¼ˆcacheabilityï¼‰å±æ€§ã€‚</p></li>
<li><p><strong>EPD0å’ŒEPD1</strong>ï¼šç”¨äºé…ç½®æ˜¯å¦å¯ç”¨è‡ªåŠ¨é¡µè¡¨æ›´æ–°ã€‚</p></li>
<li><p><strong>A1å’ŒEPD1</strong>ï¼šè¿™äº›ä½ç”¨äºé…ç½®æ˜¯å¦å¯ç”¨ç¬¬äºŒçº§é¡µè¡¨ã€‚</p></li>
<li><p><strong>TBI0å’ŒTBI1</strong>ï¼šç”¨äºé…ç½®æ˜¯å¦å¯ç”¨Top Byte
Ignoreï¼Œè¿™å…è®¸åœ¨é¡µè¡¨ç¿»è¯‘è¿‡ç¨‹ä¸­å¿½ç•¥è™šæ‹Ÿåœ°å€çš„æœ€é«˜å­—èŠ‚ï¼Œç”¨äºåœ°å€ç©ºé—´æ‰©å±•ã€‚</p></li>
</ol>
<p>è¿™äº›å­—æ®µçš„å…·ä½“é…ç½®å–å†³äºç³»ç»Ÿçš„éœ€æ±‚å’Œæ“ä½œç³»ç»Ÿçš„æ”¯æŒã€‚é€šè¿‡é€‚å½“åœ°é…ç½®TCRå¯„å­˜å™¨ï¼Œå¯ä»¥å®ç°ä¸åŒçš„å†…å­˜æ˜ å°„å’Œå®‰å…¨ç­–ç•¥ï¼Œä»¥æ»¡è¶³ç‰¹å®šåº”ç”¨çš„éœ€æ±‚ã€‚è¦äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒARMv8æ¶æ„çš„å®˜æ–¹æ–‡æ¡£æˆ–ç‰¹å®šå¤„ç†å™¨çš„æŠ€æœ¯å‚è€ƒæ‰‹å†Œã€‚</p>
<p>LPAEï¼ˆLarge Physical Address
Extensionï¼‰æ˜¯ARMv8æ¶æ„ä¸­çš„ä¸€é¡¹æŠ€æœ¯ï¼Œç”¨äºæ‰©å±•å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰çš„ç‰©ç†åœ°å€ç©ºé—´å¤§å°ã€‚LPAEçš„ä¸»è¦ç›®çš„æ˜¯æ”¯æŒæ›´å¤§çš„ç‰©ç†å†…å­˜åœ°å€èŒƒå›´ï¼Œä»¥é€‚åº”ç°ä»£è®¡ç®—éœ€æ±‚ã€‚</p>
<p>åœ¨ARMv8æ¶æ„ä¸­ï¼ŒLPAEå…è®¸ç³»ç»Ÿä½¿ç”¨64ä½ç‰©ç†åœ°å€ï¼Œè¿™ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿç®¡ç†å’Œè®¿é—®æ›´å¤šçš„ç‰©ç†å†…å­˜ã€‚ä¼ ç»Ÿçš„32ä½ARMæ¶æ„ä»…æ”¯æŒ32ä½ç‰©ç†åœ°å€ï¼Œé™åˆ¶äº†å¯å¯»å€çš„ç‰©ç†å†…å­˜èŒƒå›´ã€‚é€šè¿‡å¼•å…¥LPAEï¼ŒARMv8å¯ä»¥æ”¯æŒé«˜è¾¾64ä½çš„ç‰©ç†åœ°å€ï¼Œä»è€Œæé«˜äº†å†…å­˜çš„æ‰©å±•æ€§å’Œå®¹é‡ã€‚</p>
<p>LPAEæŠ€æœ¯çš„å¼•å…¥ä½¿å¾—ARMv8æ¶æ„æ›´é€‚åˆç”¨äºé«˜æ€§èƒ½è®¡ç®—å’ŒæœåŠ¡å™¨é¢†åŸŸï¼Œå› ä¸ºå®ƒå¯ä»¥è½»æ¾å¤„ç†å¤§è§„æ¨¡å†…å­˜çš„éœ€æ±‚ã€‚è¿™å¯¹äºè™šæ‹ŸåŒ–ã€å¤§æ•°æ®å¤„ç†ä»¥åŠå…¶ä»–éœ€è¦å¤§å†…å­˜çš„åº”ç”¨éå¸¸æœ‰ç›Šã€‚</p>
<p>æ€»ä¹‹ï¼ŒLPAEæ˜¯ARMv8ä¸­çš„ä¸€é¡¹æŠ€æœ¯ï¼Œç”¨äºæ‰©å±•ç‰©ç†å†…å­˜åœ°å€ç©ºé—´ï¼Œæ”¯æŒæ›´å¤§å®¹é‡çš„å†…å­˜ã€‚</p>
<h1 id="gem5-add-l3-cache">gem5 add L3 cache</h1>
<p>https://gem5systemsimulaor.blogspot.com/2017/09/adding-l3-cache-in-gem5.html</p>
<hr />
<h2 id="ç‰©ç†é¡µåˆ†é…æµç¨‹">ç‰©ç†é¡µåˆ†é…æµç¨‹</h2>
<p>gem5::ArmLinuxProcess64::initState --&gt;&gt;
gem5::ArmProcess64::initState --&gt;&gt; gem5::Process::initState
--&gt;&gt; gem5::loader::Memorylmage::write --&gt;&gt;
gem5::TranslatingPortProxy::tryWriteBlob --&gt;&gt;
TranslatingPortProxy::tryOnBlob --&gt;&gt;
TranslatingPortProxy::fixupRange() ==&gt;&gt;
SETranslatingPortProxy::fixupRange() --&gt;&gt; Process::allocateMem()
--&gt;&gt; SEWorkload::allocPhysPages() &amp;&amp;
EmulationPageTable::map()</p>
<p>--&gt;&gt; TranslatingPortProxy::tryReadBlob() --&gt;&gt;
TranslatingPortProxy::tryOnBlob --&gt;&gt;
TranslatingPortProxy::fixupRange() ==&gt;&gt;
SETranslatingPortProxy::fixupRange() --&gt;&gt; Process::allocateMem()
--&gt;&gt; SEWorkload::allocPhysPages() &amp;&amp;
EmulationPageTable::map()</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Yuhang Zhang
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="https://zyh-eric.gitee.io/zyhjy/2023/08/18/gem5/" title="gem5 O3CPU guidelines">https://zyh-eric.gitee.io/zyhjy/2023/08/18/gem5/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/zyhjy/tags/lab/" rel="tag"><i class="fa fa-tag"></i> lab</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/zyhjy/2023/08/16/FS-Full-System-Emulation/" rel="prev" title="gem5 Full System Simulation">
      <i class="fa fa-chevron-left"></i> gem5 Full System Simulation
    </a></div>
      <div class="post-nav-item">
    <a href="/zyhjy/2023/08/18/%E8%A7%A3%E5%86%B3%E6%89%93%E5%AE%B6%E5%8A%AB%E8%88%8D%E7%B3%BB%E5%88%97%E9%97%AE%E9%A2%98/" rel="next" title="è§£å†³æ‰“å®¶åŠ«èˆç³»åˆ—é—®é¢˜">
      è§£å†³æ‰“å®¶åŠ«èˆç³»åˆ—é—®é¢˜ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81ODg3Ni8zNTMzOA=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yuhang Zhang"
      src="/zyhjy/images/zyhjy.png">
  <p class="site-author-name" itemprop="name">Yuhang Zhang</p>
  <div class="site-description" itemprop="description">çˆ±å°é›…ï¼Œçˆ±ç”Ÿæ´»ï¼Œçˆ±ç‰©ç†!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/zyhjy/archives/">
        
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/zyhjy/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/zyhjy/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/zyhjy/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022 â€“ 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yuhang Zhang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">439k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">12:11</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/zyhjy/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>

<script src="/zyhjy/js/utils.js"></script>


<script src="/zyhjy/js/schemes/pisces.js"></script>


<script src="/zyhjy/js/next-boot.js"></script>




  




  
<script src="/zyhjy/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: 'ğŸŒ“',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
